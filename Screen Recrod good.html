<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Recorder V.8 (Pastel Mobile)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- โหลดฟอนต์น่ารักๆ (Mali) -->
    <link href="https://fonts.googleapis.com/css2?family=Mali:wght@300;500;700&family=Sarabun:wght@400;600&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Mali', cursive;
            transition: background 0.5s ease;
        }

        /* Animation ปุ่มดุ๊กดิ๊ก */
        .btn-bounce:active {
            transform: scale(0.90);
        }

        .btn-hover:hover {
            transform: translateY(-3px);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        /* พื้นหลังพลาสเทลต่างๆ */
        .bg-candy {
            background-image: linear-gradient(120deg, #fccb90 0%, #d57eeb 100%);
        }

        .bg-mint {
            background-image: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%);
        }

        .bg-lavender {
            background-image: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%);
        }

        .bg-sunshine {
            background-image: linear-gradient(120you, #f6d365 0%, #fda085 100%);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 4px solid rgba(255, 255, 255, 0.6);
        }
    </style>
</head>

<body class="bg-candy min-h-screen flex flex-col items-center py-6 px-4 text-slate-700" id="mainBody">

    <!-- Theme Switcher (ลอยอยู่ด้านบน) -->
    <div class="fixed top-4 right-4 bg-white/90 p-2 rounded-full shadow-lg flex gap-2 z-50 backdrop-blur-sm">
        <button onclick="changeTheme('bg-candy')"
            class="w-8 h-8 rounded-full bg-gradient-to-br from-orange-200 to-purple-300 border-2 border-white shadow hover:scale-110 transition"></button>
        <button onclick="changeTheme('bg-mint')"
            class="w-8 h-8 rounded-full bg-gradient-to-br from-green-200 to-blue-200 border-2 border-white shadow hover:scale-110 transition"></button>
        <button onclick="changeTheme('bg-lavender')"
            class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-200 to-blue-200 border-2 border-white shadow hover:scale-110 transition"></button>
        <button onclick="changeTheme('bg-sunshine')"
            class="w-8 h-8 rounded-full bg-gradient-to-br from-yellow-200 to-orange-200 border-2 border-white shadow hover:scale-110 transition"></button>
    </div>

    <!-- Main Card -->
    <div class="glass-panel w-full max-w-lg md:max-w-4xl p-6 rounded-[2rem] shadow-xl relative">

        <!-- Header -->
        <div class="text-center mb-6">
            <h1
                class="text-3xl md:text-4xl font-bold text-slate-700 drop-shadow-sm flex items-center justify-center gap-2">
                <i class="fas fa-video text-pink-500"></i>
                <span>Recorder <span class="text-pink-500">Cute</span></span>
            </h1>
            <p class="text-slate-500 text-sm mt-1 font-sans">บันทึกหน้าจอ (Offline MP4)</p>
        </div>

        <!-- Mobile iOS Warning -->
        <div id="iosWarning"
            class="hidden mb-4 bg-red-100 text-red-600 p-4 rounded-xl text-sm text-center border-2 border-red-200 font-sans">
            <i class="fas fa-apple text-xl mb-1"></i><br>
            <b>ขออภัย!</b> ระบบ iOS (iPhone/iPad) <br>ไม่อนุญาตให้อัดหน้าจอผ่านเว็บไซต์<br>
            <span class="text-xs">กรุณาใช้ Android หรือ คอมพิวเตอร์นะจ๊ะ</span>
        </div>

        <div class="flex flex-col md:flex-row gap-6">

            <!-- Mobile: Video Preview ไว้บนสุด -->
            <div class="w-full md:w-2/3 order-1 md:order-2">
                <div
                    class="relative w-full aspect-video bg-slate-900 rounded-2xl overflow-hidden shadow-inner border-4 border-white ring-4 ring-pink-100 group">
                    <video id="videoPreview" autoplay muted class="w-full h-full object-contain"></video>

                    <!-- Overlay Text -->
                    <div id="overlayText"
                        class="absolute inset-0 flex flex-col items-center justify-center text-white/60 pointer-events-none">
                        <i class="fas fa-play-circle text-5xl mb-2 opacity-80 animate-pulse"></i>
                        <span class="font-bold text-lg">Preview Here</span>
                    </div>

                    <!-- REC Badge -->
                    <div id="recIndicator"
                        class="hidden absolute top-3 right-3 bg-red-500 text-white text-[10px] font-bold px-3 py-1 rounded-full flex items-center gap-1 shadow animate-pulse">
                        <i class="fas fa-circle text-[6px]"></i> REC
                    </div>
                </div>

                <!-- Timer & Status -->
                <div class="mt-4 flex justify-between items-center bg-white/60 p-3 rounded-xl">
                    <div class="text-3xl font-bold text-slate-700 tracking-wider font-sans" id="timerDisplay">00:00:00
                    </div>
                    <div class="text-right">
                        <div id="fileSize" class="text-xs font-bold text-pink-500">Size: 0 MB</div>
                        <div class="text-[10px] text-slate-400 font-sans">High Quality Audio</div>
                    </div>
                </div>
            </div>

            <!-- Settings (Side Panel) -->
            <div class="w-full md:w-1/3 order-2 md:order-1 flex flex-col gap-4">

                <!-- Format Box -->
                <div class="bg-white/60 p-4 rounded-2xl border-2 border-white">
                    <label class="font-bold text-slate-600 mb-2 block text-sm"><i class="fas fa-film text-blue-400"></i>
                        เลือกรูปแบบไฟล์</label>
                    <div class="flex flex-col gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="format" value="mp4" checked class="peer sr-only">
                            <div
                                class="p-3 rounded-xl bg-white border-2 border-slate-100 peer-checked:border-pink-400 peer-checked:bg-pink-50 transition flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-full bg-pink-100 text-pink-500 flex items-center justify-center">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <div>
                                    <span class="font-bold text-slate-700 text-sm block">MP4 File</span>
                                    <span class="text-[10px] text-slate-400 block font-sans">แนะนำ!
                                        โหลดแล้วใช้ได้เลย</span>
                                </div>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="format" value="webm" class="peer sr-only">
                            <div
                                class="p-3 rounded-xl bg-white border-2 border-slate-100 peer-checked:border-blue-400 peer-checked:bg-blue-50 transition flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center">
                                    <i class="fas fa-cube"></i>
                                </div>
                                <div>
                                    <span class="font-bold text-slate-700 text-sm block">WebM File</span>
                                    <span class="text-[10px] text-slate-400 block font-sans">ขนาดเล็ก สำหรับเว็บ</span>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Control Buttons -->
                <div class="grid grid-cols-1 gap-3 mt-auto">
                    <button id="btnStart"
                        class="btn-bounce btn-hover bg-gradient-to-r from-pink-400 to-rose-400 text-white font-bold py-4 rounded-2xl shadow-lg shadow-pink-200 flex items-center justify-center gap-2 text-lg">
                        <i class="fas fa-video"></i> เริ่มอัดหน้าจอ
                    </button>

                    <button id="btnStop"
                        class="hidden btn-bounce btn-hover bg-gradient-to-r from-red-400 to-orange-400 text-white font-bold py-4 rounded-2xl shadow-lg shadow-red-200 flex items-center justify-center gap-2 text-lg animate-pulse">
                        <i class="fas fa-stop"></i> หยุดอัด
                    </button>

                    <button id="btnSave"
                        class="hidden btn-bounce btn-hover bg-gradient-to-r from-emerald-400 to-teal-400 text-white font-bold py-4 rounded-2xl shadow-lg shadow-emerald-200 flex items-center justify-center gap-2 text-lg">
                        <i class="fas fa-cloud-download-alt"></i> โหลดวิดีโอ
                    </button>
                </div>

            </div>
        </div>

        <!-- Footer -->
        <div class="mt-6 text-center text-xs text-slate-500/70 font-sans">
            Created with <i class="fas fa-heart text-pink-400"></i> by <b>THANAT Y.</b> (HR IT #526)
        </div>
    </div>

    <script>
        // DOM Elements
        const mainBody = document.getElementById('mainBody');
        const btnStart = document.getElementById('btnStart');
        const btnStop = document.getElementById('btnStop');
        const btnSave = document.getElementById('btnSave');
        const videoPreview = document.getElementById('videoPreview');
        const timerDisplay = document.getElementById('timerDisplay');
        const fileSizeDisplay = document.getElementById('fileSize');
        const overlayText = document.getElementById('overlayText');
        const recIndicator = document.getElementById('recIndicator');
        const iosWarning = document.getElementById('iosWarning');

        let mediaRecorder;
        let stream;
        let recordedChunks = [];
        let timerInterval;
        let startTime;
        let actualMimeType = "";
        let finalBlob = null;
        let totalSize = 0;

        // --- Theme Switcher ---
        function changeTheme(themeClass) {
            mainBody.className = `min-h-screen flex flex-col items-center py-6 px-4 text-slate-700 ${themeClass}`;
        }

        // --- Check iOS ---
        function checkIOS() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if (isIOS) {
                iosWarning.classList.remove('hidden');
                // iOS ไม่รองรับ getDisplayMedia เว็บส่วนใหญ่จึงปิดปุ่ม
                // แต่เราเปิดไว้ให้กดแล้วเจอ Error แจ้งเตือนจาก Browser เองก็ได้
            }
        }
        checkIOS();

        function getMimeType(preference) {
            const mp4Types = ["video/mp4; codecs=avc1", "video/mp4", "video/webm; codecs=h264"];
            const webmTypes = ["video/webm; codecs=vp9", "video/webm"];
            const types = preference === 'mp4' ? [...mp4Types, ...webmTypes] : [...webmTypes, ...mp4Types];
            for (const type of types) {
                if (MediaRecorder.isTypeSupported(type)) return type;
            }
            return "";
        }

        function formatBytes(bytes) {
            if (bytes === 0) return 'Size: 0 MB';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return 'Size: ' + parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        btnStart.addEventListener('click', async () => {
            const formatPref = document.querySelector('input[name="format"]:checked').value;
            finalBlob = null;
            recordedChunks = [];
            totalSize = 0;
            btnSave.classList.add('hidden');
            fileSizeDisplay.innerText = "Size: 0 MB";

            try {
                // สำหรับ Mobile: ใช้ getDisplayMedia (Android Chrome รองรับ)
                stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: "always" },
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });

                videoPreview.srcObject = stream;
                overlayText.style.display = 'none';
                recIndicator.classList.remove('hidden');

                const mimeType = getMimeType(formatPref);
                if (!mimeType) {
                    alert("Browser does not support screen recording (iOS may not work)");
                    return;
                }

                mediaRecorder = new MediaRecorder(stream, { mimeType });
                currentMimeType = mediaRecorder.mimeType;

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                        totalSize += event.data.size;
                        fileSizeDisplay.innerText = formatBytes(totalSize);
                    }
                };

                mediaRecorder.onstop = () => {
                    stopTimer();
                    stopStream();
                    finalBlob = new Blob(recordedChunks, { type: currentMimeType });

                    btnStart.style.display = 'flex';
                    btnStop.style.display = 'none';
                    btnSave.classList.remove('hidden');
                    recIndicator.classList.add('hidden');
                    overlayText.style.display = 'flex';
                    overlayText.innerHTML = '<i class="fas fa-check-circle text-green-400 text-5xl mb-2"></i><span class="font-bold text-slate-100">เรียบร้อยแล้วจ้า</span>';
                };

                mediaRecorder.start(1000);
                startTimer();

                btnStart.style.display = 'none';
                btnStop.style.display = 'flex';

                stream.getVideoTracks()[0].onended = () => {
                    if (mediaRecorder.state !== 'inactive') mediaRecorder.stop();
                };

            } catch (err) {
                console.error(err);
                if (err.name === 'NotAllowedError') {
                    The user presses Cancel or the browser does not grant permission.
                    return;
                }
                alert("เกิดข้อผิดพลาด: " + err.message + "\n(หมายเหตุ: iOS ไม่รองรับฟีเจอร์นี้)");
            }
        });

        btnStop.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
        });

        btnSave.addEventListener('click', () => {
            if (!finalBlob) return;
            const url = URL.createObjectURL(finalBlob);
            const a = document.createElement("a");

            currentMimeTypeext = years;
            if (currentMimeType.includes("mp4") || document.querySelector('input[name="format"]:checked').value === "mp4") {
                ext = "mp4";
            }

            const now = new Date();
            const fileName = `CuteRec_${now.getHours()}${now.getMinutes()}_${now.getDate()}.${ext}`;

            a.style.display = "none";
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();

            setTimeout(() => {
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }, 100);
        });

        function stopStream() {
            if (stream) stream.getTracks().forEach(track => track.stop());
            videoPreview.srcObject = null;
        }

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const diff = Date.now() - startTime;
                const date = new Date(diff);
                timerDisplay.innerText = date.toISOString().substr(11, 8);
            }, 1000);
        }

        function stopTimer() { clearInterval(timerInterval); }
    </script>
</body>

</html>
